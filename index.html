<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>学习计划与打卡统计助手</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Heiti TC', 'Microsoft YaHei', sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 10px;
            max-width: 1000px;
            margin: 0 auto;
        }

        /* 顶部第一板块 */
        .header-top {
            background: linear-gradient(135deg, #2c5aa0, #4b6bbe);
            color: white;
            border-radius: 12px;
            padding: 20px 15px;
            text-align: center;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .header-top h1 {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .header-top p {
            font-size: 12px;
        }

        /* 顶部第二板块 */
        .header-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 16px;
            font-weight: bold;
            color: #4b6bbe;
        }

        /* 中间部分 */
        .middle-section {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        /* 计划模板竖排文字 */
        .template-label {
            writing-mode: vertical-lr;
            text-orientation: mixed;
            background: white;
            border-radius: 12px;
            padding: 15px 5px;
            font-size: 16px;
            font-weight: bold;
            color: #4b6bbe;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            height: fit-content;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* 右侧内容区域 */
        .content-area {
            flex: 1;
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        /* 学习计划头部 */
        .plan-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .plan-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .plan-actions {
            display: flex;
            gap: 10px;
        }

        .btn-batch {
            background: #63c5e0;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-add {
            background: #4b6bbe;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* 周视图头部 */
        .week-header {
            background: #eff8ff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .week-title {
            font-size: 15px;
            font-weight: bold;
            color: #4b6bbe;
        }

        .week-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .week-controls select {
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .week-controls .btn {
            background: #4b6bbe;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 自定义时间选择器 */
        .custom-time-selector {
            display: flex;
            align-items: center;
            background: #fd9400;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: bold;
            gap: 8px;
            cursor: pointer;
        }

        .custom-time-selector i {
            font-size: 13px;
        }

        /* 日历按钮 */
        .calendar-btn {
            background: #4b6bbe;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 周视图日历 */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-bottom: 20px;
        }

        .calendar-day {
            height: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            background: #d4e3f8;
            cursor: pointer;
            font-size: 14px;
            padding: 5px;
            transition: all 0.2s ease;
        }

        .calendar-day:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .calendar-day.today {
            background: #fd9400;
            color: white;
        }

        .calendar-day.selected {
            background: #4b6bbe;
            color: white;
        }

        .calendar-day.checked {
            background: #8bb3f2;
            color: white;
        }

        .weekday {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 2px;
        }

        .date {
            font-size: 14px;
            font-weight: bold;
        }

        /* 计划项列表 */
        .plan-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .plan-item {
            display: flex;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }

        /* 科目区域 - 宽度调整为30px，字体加粗 */
        .plan-subject {
            width: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 15px;
            font-weight: bold;
            writing-mode: vertical-lr;
            text-orientation: mixed;
            padding: 15px 0;
        }

        .plan-subject.english {
            background: linear-gradient(to bottom, #c690ce, #a56cb5);
        }

        .plan-subject.chinese {
            background: linear-gradient(to bottom, #99ddae, #7bc593);
        }

        .plan-subject.math {
            background: linear-gradient(to bottom, #f79d82, #e88568);
        }

        .plan-subject.sports {
            background: linear-gradient(to bottom, #6ac9e0, #4bb3d3);
        }

        .plan-subject.other {
            background: linear-gradient(to bottom, #5f7ebe, #4b6bbe);
        }

        /* 新增历史、道法科目样式 */
        .plan-subject.history {
            background: linear-gradient(to bottom, #7dcedf, #5fb8cd);
        }

        .plan-subject.daofa {
            background: linear-gradient(to bottom, #7dcedf, #5fb8cd);
        }

        /* 计划内容区域 - 调整内边距 */
        .plan-content {
            flex: 1;
            padding: 4px 6px 1px; 
            background: #e0f8e8;
            margin-right: 0;
            border-right: 1px solid #d1d9e6;
            position: relative;
            height: 120px;
        }

        .plan-item.running .plan-content {
            background: white;
        }

        .plan-item.completed .plan-content {
            background: #e0f8e8;
        }

        /* 优化计划头部布局 - 确保在一行显示 */
        .plan-header-row {
            display: flex;
            align-items: center;
            gap: 10px; 
            margin-bottom: 1px;
            flex-wrap: nowrap;
            overflow-x: auto;
            padding-bottom: 3px;
        }

        .plan-name {
            font-size: 16px;
            font-weight: bold;
            color: #28a745;
            font-family: "黑体", sans-serif;
            border: none;
            background: transparent;
            outline: none;
            min-width: 65px;
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }

        .plan-repeat {
            font-size: 14px;
            color: #4b6bbe;
            font-family: "黑体", sans-serif;
            font-weight: bold;
            white-space: nowrap;
        }

        .plan-time {
            font-size: 14px;
            color: #c690ce;
            font-family: "黑体", sans-serif;
            font-weight: bold;
            white-space: nowrap;
        }

        .plan-actual-time {
            font-size: 14px;
            color: #ff0000;
            font-family: "黑体", sans-serif;
            font-weight: bold;
            white-space: nowrap;
        }

        /* 计划用时输入框样式 */
        .planned-duration {
            font-size: 14px;
            color: #c690ce;
            font-family: "黑体", sans-serif;
            font-weight: bold;
            white-space: nowrap;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 2px 4px;
            background: white;
            width: 66px;
        }

        /* 计划用时标签样式 */
        .duration-label {
            font-size: 14px;
            color: #c690ce;
            font-family: "黑体", sans-serif;
            font-weight: bold;
            white-space: nowrap;
            width: 60px;
        }

        /* 内容文本框背景色 - 调整内边距 */
        .plan-desc {
            font-size: 14px;
            color: #333;
            margin-bottom: 0.5px;
            font-family: "黑体", sans-serif;
            border: 1px solid #ddd;
            padding: 6px; 
            border-radius: 4px;
            min-height: 25px;
            resize: vertical;
            width: 100%;
            background: #f9f9f9;
        }

        /* 详情页跳转区域 */
        .detail-jump-area {
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #4b6bbe;
            font-size: 12px;
            transition: all 0.2s ease;
            margin-bottom: 0.5px; 
            font-size: 0;
        }

        .detail-jump-area i {
            font-size: 0;
        }

        .detail-jump-area span {
            font-size: 0;
        }

        .detail-jump-area:hover {
            background: #f0f4f8;
            border-radius: 4px;
        }

        /* 计时/完成状态区域 */
        .plan-status {
            width: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 12px 8px;
            background: #f0f4f8;
        }

        .timer-display {
            width: 100%;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 18px;
            font-weight: bold;
            background: white;
            border: 1px solid #dee2e6;
            font-family: 'Courier New', Courier, monospace;
            letter-spacing: 0.8px;
            padding: 0 5px;
        }

        .timer-display.timing {
            color: #e1443b;
            font-size: 18px;
            font-family: 'Courier New', Courier, monospace;
            letter-spacing: 0.8px;
        }

        .timer-display.completed {
            color: #28a745;
            font-family: 'Courier New', Courier, monospace;
            letter-spacing: 0.8px;
        }

        .timer-controls {
            display: flex;
            gap: 15px;
            width: 100%;
            justify-content: center;
        }

        .timer-btn {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .timer-btn.start {
            background: #26b563;
        }

        .timer-btn.pause {
            background: #f8d287;
        }

        .timer-btn.stop {
            background: #e1443b;
        }

        .completed-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            background: #28a745;
            color: white;
            border-radius: 4px;
            padding: 5px;
            font-size: 12px;
            font-weight: bold;
            gap: 5px;
            width: 70%;
            min-width: 70px;
        }

        .completed-circle {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: white;
            color: #28a745;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }

        /* 底部区域 */
        .data-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .data-actions .btn {
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        #backup-btn {
            background: #28a745;
        }

        #import-btn {
            background: #6f42c1;
        }

        #clear-btn {
            background: #dc3545;
        }

        .footer {
            text-align: center;
            margin-top: 25px;
            font-size: 12px;
            color: #999;
        }

        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        /* 时间选择器样式 */
        .time-range-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .time-picker {
            display: flex;
            align-items: center;
            background: #fd9400;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            gap: 8px;
            cursor: pointer;
            flex: 1;
            justify-content: center;
        }

        .time-picker i {
            font-size: 13px;
        }

        .time-range-display {
            display: flex;
            align-items: center;
            background: #f0f8ff;
            border: 1px solid #cce5ff;
            border-radius: 6px;
            padding: 10px;
            flex: 1;
            justify-content: center;
            font-weight: bold;
            color: #4b6bbe;
        }

        .time-range-display span {
            margin: 0 5px;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .form-actions .btn {
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-cancel {
            background: #f0f0f0;
            color: #333;
            border: 1px solid #ddd;
        }

        .btn-save {
            background: #4b6bbe;
            color: white;
            border: none;
        }

        /* 批量添加模态框 */
        .batch-input {
            width: 100%;
            height: 200px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            resize: vertical;
        }

        /* 数据管理模态框 */
        .data-import {
            width: 100%;
            height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            resize: vertical;
        }

        .backup-info {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            font-size: 14px;
            color: #4b6bbe;
        }

        /* 详情页面模态框样式 */
        .detail-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            z-index: 2000;
            overflow-y: auto;
            padding: 15px;
        }
        
        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .back-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
            background: none;
            border: none;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            background-color: #496db9;
            width: 80px;
            justify-content: center;
        }
        
        .detail-actions {
            display: flex;
            gap: 15px;
        }
        
        .detail-action-btn {
            background: none;
            border: none;
            color: #496db9;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 0;
            transition: color 0.2s;
        }
        
        .detail-action-btn:hover {
            color: #2c5aa0;
        }
        
        .plan-title-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 25px;
            text-align: center;
            position: relative;
        }
        
        /* 修改详情页计划名称和重复频率布局 */
        .plan-name-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 15px;
            position: relative;
        }
        
        .plan-name-large {
            font-size: 50px;
            color: #496db9;
            font-weight: bold;
            text-align: center;
            line-height: 1.2;
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'Courier New', Courier, monospace;
            font-weight: bold; 
            letter-spacing: 1px; 
            position: relative;
            padding-bottom: 10px;
        }
        
        .repeat-badge {
            background-color: #cfedf3;
            color: #496db9;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            text-align: center;
            position: absolute;
            right: -20px;
            bottom: 0;
            transform: translateX(100%);
            white-space: nowrap;
            font-family: 'Courier New', Courier, monospace; 
            font-weight: bold; 
            letter-spacing: 0.5px; 
        }
        
        .timer-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 25px;
            padding: 20px;
            background-color: #f5f7fa;
            border-radius: 12px;
        }
        
        /* 修改详情页计时器字体为等宽字体，加粗 */
        .detail-timer-display {
            font-size: 120px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
            background: none;
            border: none;
            box-shadow: none;
            padding: 0;
            width: auto;
            font-family: 'Courier New', monospace;
            font-weight: 900;
            letter-spacing: 1px;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .detail-timer-display.timing {
            color: #e1443b;
        }
        
        .detail-timer-display.completed {
            color: #28a745;
        }
        
        .detail-timer-controls {
            display: flex;
            gap: 25px;
        }
        
        /* 详情页计时器按钮样式调整 */
        .detail-timer-btn {
            display: flex;
            align-items: center;
            gap: 8px; 
            color: white;
            border: none;
            padding: 8px 16px; 
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        .detail-timer-btn i {
            font-size: 18px; 
            color: white; 
            vertical-align: middle; 
        }

        .detail-timer-btn:hover {
            transform: scale(1.05); 
        }

        .detail-timer-btn.start {
            background-color: #26b563;
        }

        .detail-timer-btn.pause {
            background-color: #f8d287;
        }

        .detail-timer-btn.stop {
            background-color: #e1443b;
        }
        
        .info-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .info-card {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .info-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 18px;
            color: #496db9;
            font-weight: bold;
        }

        .info-title i {
            font-size: 18px;
        }
        
        .info-content {
            font-size: 16px;
            color: #333;
        }
        
        .description-section {
            margin-bottom: 25px;
        }
        
        .description-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        
        .description-content {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            min-height: 100px;
            font-family: "黑体", sans-serif;
            font-size: 16px;
            resize: vertical;
            width: 100%;
        }

        /* 全年日历模态框样式 */
        .year-calendar {
            max-width: 600px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .calendar-nav {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .calendar-nav-btn {
            background: #4b6bbe;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calendar-month-year {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .calendar-grid-year {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-weekday {
            text-align: center;
            font-weight: bold;
            padding: 10px 0;
            color: #4b6bbe;
        }

        .calendar-day-year {
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .calendar-day-year:hover {
            background: #e6f0ff;
        }

        .calendar-day-year.today {
            background: #fd9400;
            color: white;
        }

        .calendar-day-year.selected {
            background: #4b6bbe;
            color: white;
        }

        .calendar-day-year.other-month {
            color: #ccc;
        }

 /* 新增样式：禁用状态 */
        .timer-btn.disabled {
            background: #ccc !important;
            cursor: not-allowed;
        }
        
        .plan-item.disabled .timer-btn {
            background: #ccc !important;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <!-- 顶部第一板块 -->
    <div class="header-top">
        <h1>学习计划与打卡统计助手</h1>
        <p>你已坚持打卡<span id="streak-days">0</span>天，已累计完成<span id="total-plans">0</span>个学习计划！</p>
    </div>

    <!-- 顶部第二板块 -->
    <div class="header-stats">
                <div class="stat-card">
            <div class="stat-label">学习时间</div>
            <div class="stat-value" id="today-study-time">0h</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">运动户外时间</div>
            <div class="stat-value" id="today-sports-time">0h</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">任务数量</div>
            <div class="stat-value" id="today-tasks">0/0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">完成率</div>
            <div class="stat-value" id="today-completion">0%</div>
        </div>
    </div>

    <!-- 中间部分 -->
    <div class="middle-section">
        <!-- 左侧计划模板 -->
        <div class="template-label">
            <i class="fas fa-clipboard-list"></i> 计划模版
        </div>

        <!-- 右侧内容区域 -->
        <div class="content-area">
            <!-- 学习计划头部 -->
            <div class="plan-header">
                <div class="plan-title">
                    <i class="fas fa-book"></i> 学习计划
                </div>
                <div class="plan-actions">
                    <button class="btn-batch" id="batch-add-btn">
                        <i class="fas fa-layer-group"></i> 批量添加
                    </button>
                    <button class="btn-add" id="add-plan-btn">
                        <i class="fas fa-plus"></i> 添加计划
                    </button>
                </div>
            </div>

            <!-- 周视图头部 -->
            <div class="week-header">
                <div class="week-title" id="week-title"></div>
                <div class="week-controls">
                    <button class="btn" id="prev-week-btn"><i class="fas fa-chevron-left"></i></button>
                    <div class="custom-time-selector" id="today-btn">
                        <i class="fas fa-calendar"></i>
                        <span>今天</span>
                    </div>
                    <button class="btn" id="next-week-btn"><i class="fas fa-chevron-right"></i></button>
                    <button class="calendar-btn" id="full-calendar-btn">
                        <i class="fas fa-calendar-alt"></i>
                    </button>
                </div>
            </div>

            <!-- 周视图日历 -->
            <div class="calendar-grid" id="calendar-grid">
                <!-- 日历将通过JS动态生成 -->
            </div>

            <!-- 计划项列表 -->
            <div class="plan-list" id="plan-list">
                <!-- 计划项将通过JS动态生成 -->
            </div>
        </div>
    </div>

    <!-- 底部区域 -->
    <div class="data-actions">
        <button class="btn" id="backup-btn">
            <i class="fas fa-save"></i> 备份数据
        </button>
        <button class="btn" id="import-btn">
            <i class="fas fa-file-import"></i> 导入数据
        </button>
        <button class="btn" id="clear-btn">
            <i class="fas fa-trash"></i> 清空学习计划
        </button>
    </div>

    <div class="footer">
        学习计划与打卡统计助手 | 设计原则：劳逸结合·科学规划·快乐学习
    </div>

    <!-- 添加计划模态框 -->
    <div class="modal" id="add-plan-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">添加学习计划</div>
                <button class="close-btn" id="close-add-plan-modal">&times;</button>
            </div>
            <form id="add-plan-form">
                <div class="form-group">
                    <label for="plan-subject">科目</label>
                    <select id="plan-subject" class="form-control" required>
                        <option value="">选择科目</option>
                        <option value="english">英语</option>
                        <option value="chinese">语文</option>
                        <option value="math">数学</option>
                        <option value="sports">运动</option>
                        <option value="history">历史</option>
                        <option value="daofa">道法</option>
                        <option value="other">其他</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="plan-name">计划名称</label>
                    <input type="text" id="plan-name" class="form-control" placeholder="例如：星火英语" required>
                </div>
                <div class="form-group">
                    <label for="planned-duration">计划用时</label>
                    <input type="text" id="planned-duration" class="form-control" placeholder="例如：30min" required>
                </div>
                <div class="form-group">
                    <label for="plan-repeat">重复频率</label>
                    <select id="plan-repeat" class="form-control" required>
                        <option value="once">仅当天</option>
                        <option value="daily">每天</option>
                        <option value="weekdays">周一至周五</option>
                        <option value="weekly">每周的这天</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="plan-description">计划内容</label>
                    <textarea id="plan-description" class="form-control" rows="3" placeholder="描述你的学习内容..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" id="cancel-add-plan">取消</button>
                    <button type="submit" class="btn btn-save">保存计划</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 批量添加模态框 -->
    <div class="modal" id="batch-add-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">批量添加计划</div>
                <button class="close-btn" id="close-batch-add-modal">&times;</button>
            </div>
            <form id="batch-add-form">
                <div class="form-group">
                    <label for="batch-input">批量输入计划</label>
                    <textarea id="batch-input" class="batch-input" placeholder="例如:
语文
1.完成《大青树下的小学》阅读单
2.预习《花的学校》
数学
1.完成练习册第10页
2.预习下一节"></textarea>
                </div>
                <div class="form-group">
                    <label for="batch-planned-duration">计划用时</label>
                    <input type="text" id="batch-planned-duration" class="form-control" placeholder="例如：30min" required>
                </div>
                <div class="form-group">
                    <label for="batch-repeat">重复频率</label>
                    <select id="batch-repeat" class="form-control" required>
                        <option value="once">仅当天</option>
                        <option value="daily">每天</option>
                        <option value="weekdays">周一至周五</option>
                        <option value="weekly">每周的这天</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" id="cancel-batch-add">取消</button>
                    <button type="submit" class="btn btn-save">批量添加</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 备份数据模态框 -->
    <div class="modal" id="backup-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">备份数据</div>
                <button class="close-btn" id="close-backup-modal">&times;</button>
            </div>
            <div class="backup-info">
                <p>您的学习数据已成功备份！</p>
                <p>备份时间：<span id="backup-time"></span></p>
                <p>备份内容：学习计划、打卡记录、统计信息</p>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-cancel" id="close-backup">关闭</button>
                <button type="button" class="btn btn-save" id="download-backup">下载备份文件</button>
            </div>
        </div>
    </div>

    <!-- 导入数据模态框 -->
    <div class="modal" id="import-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">导入数据</div>
                <button class="close-btn" id="close-import-modal">&times;</button>
            </div>
            <form id="import-form">
                <div class="form-group">
                    <label for="data-import">粘贴备份数据</label>
                    <textarea id="data-import" class="data-import" placeholder="请粘贴之前备份的数据"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" id="cancel-import">取消</button>
                    <button type="submit" class="btn btn-save">导入数据</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 清空数据确认模态框 -->
    <div class="modal" id="clear-confirm-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">确认清空</div>
                <button class="close-btn" id="close-clear-modal">&times;</button>
            </div>
            <p>您确定要清空所有学习计划吗？此操作不可撤销！</p>
            <div class="form-actions">
                <button type="button" class="btn btn-cancel" id="cancel-clear">取消</button>
                <button type="button" class="btn btn-save" id="confirm-clear">确认清空</button>
            </div>
        </div>
    </div>

    <!-- 编辑计划模态框 -->
    <div class="modal" id="edit-plan-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">编辑学习计划</div>
                <button class="close-btn" id="close-edit-plan-modal">&times;</button>
            </div>
            <form id="edit-plan-form">
                <div class="form-group">
                    <label for="edit-plan-subject">科目</label>
                    <select id="edit-plan-subject" class="form-control" required>
                        <option value="">选择科目</option>
                        <option value="english">英语</option>
                        <option value="chinese">语文</option>
                        <option value="math">数学</option>
                        <option value="sports">运动</option>
                        <option value="history">历史</option>
                        <option value="daofa">道法</option>
                        <option value="other">其他</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit-plan-name">计划名称</label>
                    <input type="text" id="edit-plan-name" class="form-control" placeholder="例如：星火英语" required>
                </div>
                <div class="form-group">
                    <label for="edit-planned-duration">计划用时</label>
                    <input type="text" id="edit-planned-duration" class="form-control" placeholder="例如：30min" required>
                </div>
                <div class="form-group">
                    <label for="edit-plan-repeat">重复频率</label>
                    <select id="edit-plan-repeat" class="form-control" required>
                        <option value="once">仅当天</option>
                        <option value="daily">每天</option>
                        <option value="weekdays">周一至周五</option>
                        <option value="weekly">每周的这天</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit-plan-description">计划内容</label>
                    <textarea id="edit-plan-description" class="form-control" rows="3" placeholder="描述你的学习内容..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" id="cancel-edit-plan">取消</button>
                    <button type="submit" class="btn btn-save">保存修改</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 详情页面模态框 -->
    <div class="detail-modal" id="detail-modal">
        <div class="detail-header">
            <button class="back-btn" id="back-btn">
                <i class="fas fa-arrow-left"></i>
                返回
            </button>
            <div class="detail-actions">
                <button class="detail-action-btn" id="edit-btn">
                    <i class="fas fa-edit"></i>
                    编辑
                </button>
                <button class="detail-action-btn" id="delete-btn">
                    <i class="fas fa-trash"></i>
                    删除
                </button>
            </div>
        </div>
        
        <div class="plan-title-section">
            <div class="plan-name-container">
                <div class="plan-name-large" id="detail-plan-name">
                    <i class="fas fa-book"></i> 目作文
                    <div class="repeat-badge" id="detail-repeat">重复频率：仅当天</div>
                </div>
            </div>
        </div>
        
        <div class="timer-section">
            <div class="detail-timer-display" id="detail-timer">00:00:00</div>
            <div class="detail-timer-controls">
              <button class="detail-timer-btn start" id="detail-start-btn">
        <i class="fas fa-play"></i> 开始
    </button>
    <button class="detail-timer-btn stop" id="detail-stop-btn">
        <i class="fas fa-stop"></i> 停止
    </button>
</div>
        </div>
        
        <div class="info-section">
            <div class="info-card">
                <div class="info-title">
                    <i class="fas fa-book"></i>
                    任务分类
                </div>
                <div class="info-content" id="detail-subject">语文</div>
            </div>
            
            <div class="info-card">
                <div class="info-title">
                    <i class="fas fa-clock"></i>
                    计划用时
                </div>
                 <div class="info-content" id="detail-planned-duration">30min</div>
            </div>
            
            <div class="info-card">
                <div class="info-title">
                    <i class="fas fa-calendar"></i>
                    任务日期
                </div>
                <div class="info-content" id="detail-date">2025-10-08</div>
            </div>
            
            <div class="info-card">
                <div class="info-title">
                    <i class="fas fa-history"></i>
                    实际时间
                </div>
                <div class="info-content" id="detail-actual-time">14:26 - 进行中</div>
            </div>
        </div>
        
        <div class="description-section">
            <div class="description-title">
                <i class="fas fa-file-alt"></i>
                任务说明
            </div>
            <textarea class="description-content" id="detail-description">分) 请你选择国庆假期中记忆较深的一天写一篇日记，写出自己在这一天中的所言、所行、所见、所闻和所感，注意日记的格式。</textarea>
        </div>
    </div>

    <!-- 全年日历模态框 -->
    <div class="modal" id="full-calendar-modal">
        <div class="modal-content year-calendar">
            <div class="modal-header">
                <div class="modal-title">选择日期</div>
                <button class="close-btn" id="close-full-calendar-modal">&times;</button>
            </div>
            <div class="calendar-header">
                <div class="calendar-nav">
                    <button class="calendar-nav-btn" id="prev-year-btn">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div class="calendar-month-year" id="calendar-month-year">2025年10月</div>
                    <button class="calendar-nav-btn" id="next-year-btn">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            <div class="calendar-grid-year" id="calendar-grid-year">
                <!-- 日历将通过JS动态生成 -->
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-cancel" id="cancel-full-calendar">取消</button>
                <button type="button" class="btn btn-save" id="confirm-full-calendar">确定</button>
            </div>
        </div>
    </div>

    <script>
        // 数据模型
        let plans = JSON.parse(localStorage.getItem('studyPlans')) || [];
        let checkins = JSON.parse(localStorage.getItem('studyCheckins')) || [];
        let currentWeekOffset = 0;
        let selectedDate = new Date();
        let timers = {};
        let currentDetailPlanId = null;
        let currentEditPlanId = null;
        let selectedCalendarDate = null;

        // 获取DOM元素
        const planList = document.getElementById('plan-list');
        const calendarGrid = document.getElementById('calendar-grid');
        const todayBtn = document.getElementById('today-btn');
        const addPlanBtn = document.getElementById('add-plan-btn');
        const batchAddBtn = document.getElementById('batch-add-btn');
        const backupBtn = document.getElementById('backup-btn');
        const importBtn = document.getElementById('import-btn');
        const clearBtn = document.getElementById('clear-btn');
        const prevWeekBtn = document.getElementById('prev-week-btn');
        const nextWeekBtn = document.getElementById('next-week-btn');
        const weekTitle = document.getElementById('week-title');
        const fullCalendarBtn = document.getElementById('full-calendar-btn');

        // 模态框元素
        const addPlanModal = document.getElementById('add-plan-modal');
        const batchAddModal = document.getElementById('batch-add-modal');
        const backupModal = document.getElementById('backup-modal');
        const importModal = document.getElementById('import-modal');
        const clearConfirmModal = document.getElementById('clear-confirm-modal');
        const editPlanModal = document.getElementById('edit-plan-modal');
        const detailModal = document.getElementById('detail-modal');
        const fullCalendarModal = document.getElementById('full-calendar-modal');

        // 详情页面元素
        const backBtn = document.getElementById('back-btn');
        const detailTimer = document.getElementById('detail-timer');
        const detailStartBtn = document.getElementById('detail-start-btn');
        const detailStopBtn = document.getElementById('detail-stop-btn');

        // 全年日历元素
        const calendarMonthYear = document.getElementById('calendar-month-year');
        const calendarGridYear = document.getElementById('calendar-grid-year');
        const prevYearBtn = document.getElementById('prev-year-btn');
        const nextYearBtn = document.getElementById('next-year-btn');
        const confirmFullCalendar = document.getElementById('confirm-full-calendar');

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 恢复正在运行的计时器
            restoreRunningTimers();
            
            renderCalendar();
            renderPlans();
            setupEventListeners();
            updateStats();
            updateWeekTitle();
        });

          // 恢复正在运行的计时器
    function restoreRunningTimers() {
        plans.forEach(plan => {
            if (plan.running && plan.startTime) {
                // 计算从开始到现在的时间差
                const elapsed = Date.now() - plan.startTime;
                
                // 如果计划有总持续时间，将其加上
                if (plan.totalDuration) {
                    plan.totalDuration += elapsed;
                } else {
                    plan.totalDuration = elapsed;
                }
                
                // 重置开始时间为当前时间，这样计时器会继续从正确的位置开始
                plan.startTime = Date.now();
                
                // 开始新的计时器
                startTimerInterval(plan.id);
            }
        });
    }

        // 设置事件监听器
        function setupEventListeners() {
            // 打开添加计划模态框
            addPlanBtn.addEventListener('click', function() {
                addPlanModal.style.display = 'flex';
            });

            // 打开批量添加模态框
            batchAddBtn.addEventListener('click', function() {
                batchAddModal.style.display = 'flex';
            });

            // 数据管理按钮
            backupBtn.addEventListener('click', function() {
                backupData();
            });

            importBtn.addEventListener('click', function() {
                importModal.style.display = 'flex';
            });

            clearBtn.addEventListener('click', function() {
                clearConfirmModal.style.display = 'flex';
            });

            // 周导航 - 一周一周滚动
            prevWeekBtn.addEventListener('click', function() {
                currentWeekOffset--;
                renderCalendar();
                updateWeekTitle();
            });

            nextWeekBtn.addEventListener('click', function() {
                currentWeekOffset++;
                renderCalendar();
                updateWeekTitle();
            });

            // 今天按钮点击事件 - 跳转到今天
            todayBtn.addEventListener('click', function() {
                currentWeekOffset = 0;
                selectedDate = new Date();
                renderCalendar();
                updateWeekTitle();
                renderPlans();
                updateStats();
            });

            // 打开全年日历
            fullCalendarBtn.addEventListener('click', function() {
                selectedCalendarDate = new Date(selectedDate);
                renderFullCalendar(selectedCalendarDate);
                fullCalendarModal.style.display = 'flex';
            });

            // 全年日历导航
            prevYearBtn.addEventListener('click', function() {
                selectedCalendarDate.setMonth(selectedCalendarDate.getMonth() - 1);
                renderFullCalendar(selectedCalendarDate);
            });

            nextYearBtn.addEventListener('click', function() {
                selectedCalendarDate.setMonth(selectedCalendarDate.getMonth() + 1);
                renderFullCalendar(selectedCalendarDate);
            });

            // 确认选择日期
            confirmFullCalendar.addEventListener('click', function() {
                if (selectedCalendarDate) {
                    selectedDate = new Date(selectedCalendarDate);
                    
                    // 计算选中日期所在的周偏移
                    const today = new Date();
                    const startOfThisWeek = getStartOfWeek(today);
                    const startOfSelectedWeek = getStartOfWeek(selectedDate);
                    const diffTime = startOfSelectedWeek - startOfThisWeek;
                    const diffWeeks = Math.floor(diffTime / (7 * 24 * 60 * 60 * 1000));
                    
                    currentWeekOffset = diffWeeks;
                    renderCalendar();
                    updateWeekTitle();
                    renderPlans();
                    updateStats();
                    
                    fullCalendarModal.style.display = 'none';
                }
            });

            // 详情页面返回按钮
            backBtn.addEventListener('click', function() {
                detailModal.style.display = 'none';
                currentDetailPlanId = null;
            });

           // 详情页面计时器控制
        detailStartBtn.addEventListener('click', function() {
            // 如果已经有计时器在运行，且不是当前详情页面显示的计划
            if (currentRunningTimer && currentRunningTimer !== currentDetailPlanId) {
                alert('请先完成当前正在进行的计划，再开始新的计划');
                return;
            }
            
            if (currentDetailPlanId) {
                toggleTimer(currentDetailPlanId);
            }
        });

        detailStopBtn.addEventListener('click', function() {
            if (currentDetailPlanId) {
                stopTimer(currentDetailPlanId);
            }
        });

            // 详情页面编辑和删除按钮
            document.getElementById('edit-btn').addEventListener('click', function() {
                if (currentDetailPlanId) {
                    openEditModal(currentDetailPlanId);
                }
            });

            document.getElementById('delete-btn').addEventListener('click', function() {
                if (confirm('确定要删除这个计划吗？')) {
                    if (currentDetailPlanId) {
                        const planIndex = plans.findIndex(p => p.id == currentDetailPlanId);
                        if (planIndex !== -1) {
                            // 停止计时器
                            if (timers[currentDetailPlanId]) {
                                clearInterval(timers[currentDetailPlanId]);
                                delete timers[currentDetailPlanId];
                            }
                            
                            plans.splice(planIndex, 1);
                            localStorage.setItem('studyPlans', JSON.stringify(plans));
                            renderPlans();
                            updateStats();
                            detailModal.style.display = 'none';
                            currentDetailPlanId = null;
                        }
                    }
                }
            });

            // 关闭模态框
            document.getElementById('close-add-plan-modal').addEventListener('click', function() {
                addPlanModal.style.display = 'none';
            });

            document.getElementById('close-batch-add-modal').addEventListener('click', function() {
                batchAddModal.style.display = 'none';
            });

            document.getElementById('close-backup-modal').addEventListener('click', function() {
                backupModal.style.display = 'none';
            });

            document.getElementById('close-import-modal').addEventListener('click', function() {
                importModal.style.display = 'none';
            });

            document.getElementById('close-clear-modal').addEventListener('click', function() {
                clearConfirmModal.style.display = 'none';
            });

            document.getElementById('close-edit-plan-modal').addEventListener('click', function() {
                editPlanModal.style.display = 'none';
            });

            document.getElementById('close-full-calendar-modal').addEventListener('click', function() {
                fullCalendarModal.style.display = 'none';
            });

            // 取消按钮
            document.getElementById('cancel-add-plan').addEventListener('click', function() {
                addPlanModal.style.display = 'none';
            });

            document.getElementById('cancel-batch-add').addEventListener('click', function() {
                batchAddModal.style.display = 'none';
            });

            document.getElementById('close-backup').addEventListener('click', function() {
                backupModal.style.display = 'none';
            });

            document.getElementById('cancel-import').addEventListener('click', function() {
                importModal.style.display = 'none';
            });

            document.getElementById('cancel-clear').addEventListener('click', function() {
                clearConfirmModal.style.display = 'none';
            });

            document.getElementById('cancel-edit-plan').addEventListener('click', function() {
                editPlanModal.style.display = 'none';
            });

            document.getElementById('cancel-full-calendar').addEventListener('click', function() {
                fullCalendarModal.style.display = 'none';
            });

            // 确认清空
            document.getElementById('confirm-clear').addEventListener('click', function() {
                clearAllPlans();
                clearConfirmModal.style.display = 'none';
            });

            // 表单提交
            document.getElementById('add-plan-form').addEventListener('submit', function(e) {
                e.preventDefault();
                savePlan();
            });

            document.getElementById('batch-add-form').addEventListener('submit', function(e) {
                e.preventDefault();
                batchAddPlans();
            });

            document.getElementById('import-form').addEventListener('submit', function(e) {
                e.preventDefault();
                importData();
            });

            document.getElementById('edit-plan-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveEditedPlan();
            });

            // 下载备份
            document.getElementById('download-backup').addEventListener('click', function() {
                downloadBackup();
            });

            // 点击模态框外部关闭
            window.addEventListener('click', function(event) {
                if (event.target === addPlanModal) {
                    addPlanModal.style.display = 'none';
                }
                if (event.target === batchAddModal) {
                    batchAddModal.style.display = 'none';
                }
                if (event.target === backupModal) {
                    backupModal.style.display = 'none';
                }
                if (event.target === importModal) {
                    importModal.style.display = 'none';
                }
                if (event.target === clearConfirmModal) {
                    clearConfirmModal.style.display = 'none';
                }
                if (event.target === editPlanModal) {
                    editPlanModal.style.display = 'none';
                }
                if (event.target === fullCalendarModal) {
                    fullCalendarModal.style.display = 'none';
                }
            });
        }

        // 渲染学习计划列表
        function renderPlans() {
            planList.innerHTML = '';
            
            // 获取当前选中的日期
            const targetDate = new Date(selectedDate);
            targetDate.setHours(0, 0, 0, 0);
            const targetDateStr = targetDate.toISOString().split('T')[0];
            
            // 过滤出选中日期的计划
            const selectedDatePlans = plans.filter(plan => {
                const planDate = new Date(plan.createdAt);
                planDate.setHours(0, 0, 0, 0);
                const planDateStr = planDate.toISOString().split('T')[0];
                return planDateStr === targetDateStr;
            });
            
            if (selectedDatePlans.length === 0) {
                planList.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #999;">
                        <i class="fas fa-book-open" style="font-size: 40px; margin-bottom: 15px;"></i>
                        <h3>暂无学习计划</h3>
                        <p>点击"添加计划"开始规划你的学习</p>
                    </div>
                `;
                return;
            }
            
            selectedDatePlans.forEach(plan => {
                const subjectNames = {
                    'english': '英语',
                    'chinese': '语文',
                    'math': '数学',
                    'sports': '运动',
                    'history': '历史',
                    'daofa': '道法',
                    'other': '其他'
                };
                
                const repeatNames = {
                    'once': '仅当天',
                    'daily': '每天',
                    'weekdays': '周一至周五',
                    'weekly': '每周的这天'
                };
                
                const planItem = document.createElement('div');
                planItem.className = `plan-item ${plan.completed ? 'completed' : ''} ${plan.running ? 'running' : ''}`;
                planItem.dataset.id = plan.id;

                if (currentRunningTimer && currentRunningTimer != plan.id) {
                    planItem.classList.add('disabled');
                }
                
                const iconHtml = plan.icon ? `<i class="${plan.icon}"></i>` : '';
                
                 // 计算当前持续时间
                const currentDuration = calculateCurrentDuration(plan);
                
                planItem.innerHTML = `
                    <div class="plan-subject ${plan.subject}">${subjectNames[plan.subject]}</div>
                    <div class="plan-content">
                        <div class="plan-header-row">
                            <div class="plan-name">${iconHtml} ${plan.name}</div>
                            <div class="plan-repeat">${repeatNames[plan.repeat]}</div>
                            ${plan.actualStartTime ? `<div class="plan-actual-time">实际时间: ${plan.actualStartTime}-${plan.actualEndTime || '进行中'}</div>` : ''}
                            <span class="duration-label">计划用时：</span>
                            <input type="text" class="planned-duration" value="${plan.plannedDuration || '30min'}" data-id="${plan.id}">
                        </div>
                        <textarea class="plan-desc">内容：${plan.description}</textarea>
                        <div class="detail-jump-area">
                            <i class="fas fa-external-link-alt"></i> 点击查看详情
                        </div>
                    </div>
                    <div class="plan-status">
                        <div class="timer-display ${plan.completed ? 'completed' : (plan.running ? 'timing' : '')}">
                            ${formatDuration(currentDuration)}
                        </div>
                        <div class="timer-controls">
                            ${plan.completed ? 
                                `<div class="completed-indicator">
                                    <div class="completed-circle">✓</div>
                                    <span>已完成</span>
                                </div>` : 
                                `<button class="timer-btn ${plan.running ? 'pause' : 'start'} ${(currentRunningTimer && currentRunningTimer != plan.id) ? 'disabled' : ''}" data-id="${plan.id}">
                                    ${plan.running ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play"></i>'}
                                </button>
                                <button class="timer-btn stop ${(currentRunningTimer && currentRunningTimer != plan.id) ? 'disabled' : ''}" data-id="${plan.id}"><i class="fas fa-stop"></i></button>`
                            }
                        </div>
                    </div>
                `;
                planList.appendChild(planItem);
            });

           // 添加计时按钮事件监听
            document.querySelectorAll('.timer-btn.start, .timer-btn.pause').forEach(btn => {
                btn.addEventListener('click', function() {
                    // 如果按钮被禁用，则不执行操作
                    if (this.classList.contains('disabled')) {
                        alert('请先完成当前正在进行的计划，再开始新的计划');
                        return;
                    }
                    const planId = this.getAttribute('data-id');
                    toggleTimer(planId);
                });
            });

            // 添加停止按钮事件监听
            document.querySelectorAll('.timer-btn.stop').forEach(btn => {
                btn.addEventListener('click', function() {
                    // 如果按钮被禁用，则不执行操作
                    if (this.classList.contains('disabled')) {
                        alert('请先完成当前正在进行的计划，再开始新的计划');
                        return;
                    }
                    const planId = this.getAttribute('data-id');
                    stopTimer(planId);
                });
            });

             // 为详情跳转区域添加点击事件
            document.querySelectorAll('.detail-jump-area').forEach(area => {
                area.addEventListener('click', function() {
                    const planItem = this.closest('.plan-item');
                    const planId = planItem.dataset.id;
                    openDetailModal(planId);
                });
            });

             // 添加内容编辑事件监听
            document.querySelectorAll('.plan-desc').forEach(textarea => {
                textarea.addEventListener('change', function() {
                    const planItem = this.closest('.plan-item');
                    const planId = planItem.dataset.id;
                    const planIndex = plans.findIndex(p => p.id == planId);
                    
                    if (planIndex !== -1) {
                        let content = this.value;
                        if (content.startsWith('内容：')) {
                            content = content.substring(3);
                        }
                        plans[planIndex].description = content;
                        localStorage.setItem('studyPlans', JSON.stringify(plans));
                    }
                });
            });

           // 添加计划用时编辑事件监听
            document.querySelectorAll('.planned-duration').forEach(input => {
                input.addEventListener('change', function() {
                    const planId = this.getAttribute('data-id');
                    const planIndex = plans.findIndex(p => p.id == planId);
                    
                    if (planIndex !== -1) {
                        plans[planIndex].plannedDuration = this.value;
                        localStorage.setItem('studyPlans', JSON.stringify(plans));
                    }
                });
            });
        }

           // 计算计划的当前持续时间
    function calculateCurrentDuration(plan) {
        if (plan.running && plan.startTime) {
            // 如果计时器正在运行，计算从开始时间到当前时间的时间差 + 之前累计的时间
            return (Date.now() - plan.startTime) + (plan.totalDuration || 0);
        } else if (plan.completed && plan.totalDuration) {
            // 如果已完成，返回总持续时间
            return plan.totalDuration;
        } else {
            // 否则返回已累计的时间
            return plan.totalDuration || 0;
        }
    }

        // 开始计时器间隔
        function startTimerInterval(planId) {
            // 清除现有的计时器
            if (timers[planId]) {
                clearInterval(timers[planId]);
            }
            
            // 创建新的计时器
            timers[planId] = setInterval(() => {
                const planIndex = plans.findIndex(p => p.id == planId);
                if (planIndex === -1) return;
                
                const plan = plans[planIndex];
                const currentDuration = calculateCurrentDuration(plan);
                
                // 更新主页显示
                const planElement = document.querySelector(`.plan-item[data-id="${planId}"]`);
                if (planElement) {
                    const timerDisplay = planElement.querySelector('.timer-display');
                    if (timerDisplay) {
                        timerDisplay.textContent = formatDuration(currentDuration);
                        timerDisplay.className = 'timer-display timing';
                    }
                }
                
                // 更新详情页面显示
                if (currentDetailPlanId == planId) {
                    detailTimer.textContent = formatDuration(currentDuration);
                    detailTimer.className = 'detail-timer-display timing';
                }
            }, 1000);
        }

        // 打开详情页面
        function openDetailModal(planId) {
            const planIndex = plans.findIndex(p => p.id == planId);
            
            if (planIndex === -1) return;
            
            const plan = plans[planIndex];
            currentDetailPlanId = planId;
            
            // 计算当前持续时间
            const currentDuration = calculateCurrentDuration(plan);
            
            // 填充详情页面数据
            const iconHtml = plan.icon ? `<i class="${plan.icon}"></i>` : '';
            document.getElementById('detail-plan-name').innerHTML = `${iconHtml} ${plan.name}<div class="repeat-badge" id="detail-repeat">重复频率：${getRepeatText(plan.repeat)}</div>`;
            document.getElementById('detail-timer').textContent = formatDuration(currentDuration);
            document.getElementById('detail-subject').textContent = getSubjectText(plan.subject);
            document.getElementById('detail-planned-duration').textContent = plan.plannedDuration || '30min';
            document.getElementById('detail-date').textContent = formatDate(new Date(plan.createdAt));
            document.getElementById('detail-actual-time').textContent = plan.actualStartTime ? 
                `${plan.actualStartTime} - ${plan.actualEndTime || '进行中'}` : '未开始';
            document.getElementById('detail-description').value = plan.description;
            
            // 设置计时器状态
            updateDetailTimerDisplay(plan);
            
            // 显示详情页面
            detailModal.style.display = 'block';
        }

        // 更新详情页面计时器显示
        function updateDetailTimerDisplay(plan) {
            if (plan.running) {
                // 运行时显示暂停图标
                detailStartBtn.innerHTML = '<i class="fas fa-pause"></i> 暂停';
                detailStartBtn.className = 'detail-timer-btn pause';
                detailTimer.className = 'detail-timer-display timing';
            } else if (plan.completed) {
                // 完成时显示播放图标
                detailStartBtn.innerHTML = '<i class="fas fa-play"></i> 开始';
                detailStartBtn.className = 'detail-timer-btn start';
                detailTimer.className = 'detail-timer-display completed';
            } else {
                // 未开始时显示播放图标
                detailStartBtn.innerHTML = '<i class="fas fa-play"></i> 开始';
                detailStartBtn.className = 'detail-timer-btn start';
                detailTimer.className = 'detail-timer-display';
            }
            
            // 更新计时器显示
            const currentDuration = calculateCurrentDuration(plan);
            detailTimer.textContent = formatDuration(currentDuration);
        }

        // 打开编辑模态框
        function openEditModal(planId) {
            const planIndex = plans.findIndex(p => p.id == planId);
            
            if (planIndex === -1) return;
            
            const plan = plans[planIndex];
            currentEditPlanId = planId;
            
            // 填充编辑模态框数据
            document.getElementById('edit-plan-subject').value = plan.subject;
            document.getElementById('edit-plan-name').value = plan.name;
            document.getElementById('edit-planned-duration').value = plan.plannedDuration || '30min';
            document.getElementById('edit-plan-repeat').value = plan.repeat;
            document.getElementById('edit-plan-description').value = plan.description;
            
            // 隐藏详情页面，显示编辑模态框
            detailModal.style.display = 'none';
            editPlanModal.style.display = 'flex';
        }

        // 保存计划
        function savePlan() {
            const planSubject = document.getElementById('plan-subject').value;
            const planName = document.getElementById('plan-name').value;
            const planDescription = document.getElementById('plan-description').value;
            const plannedDuration = document.getElementById('planned-duration').value;
            const planRepeat = document.getElementById('plan-repeat').value;
            
            const newPlan = {
                id: plans.length > 0 ? Math.max(...plans.map(p => p.id)) + 1 : 1,
                subject: planSubject,
                name: planName,
                description: planDescription,
                plannedDuration: plannedDuration,
                repeat: planRepeat,
                completed: false,
                running: false,
                startTime: null,
                totalDuration: 0,
                createdAt: selectedDate.toISOString()
            };
            
            plans.push(newPlan);
            
            // 保存到本地存储
            localStorage.setItem('studyPlans', JSON.stringify(plans));
            
            // 重置表单并关闭模态框
            document.getElementById('add-plan-form').reset();
            addPlanModal.style.display = 'none';
            
            // 重新渲染
            renderPlans();
            updateStats();
        }

        // 批量添加计划
function batchAddPlans() {
    const batchInput = document.getElementById('batch-input').value;
    const plannedDuration = document.getElementById('batch-planned-duration').value;
    const batchRepeat = document.getElementById('batch-repeat').value;
    
    if (!batchInput.trim()) {
        alert('请输入计划内容！');
        return;
    }
    
    const lines = batchInput.split('\n').map(line => line.trim()).filter(line => line);
    let currentSubject = '';
    let newPlans = [];
    
    // 定义运动项目列表
    const sportsItems = ['羽毛球', '游泳', '跑步', '跳绳', '篮球', '足球', '乒乓球', '网球', 
                        '排球', '健身', '瑜伽', '舞蹈', '武术', '滑板', '轮滑', '骑行'];
    
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
                
               // 检查是否是科目行
        if (['语文', '数学', '英语', '运动', '历史', '道法', '美术', '地理', '体育', '音乐', '生物'].includes(line)) {
            currentSubject = line;
        } 
        // 检查是否是任务行（以数字和点开头）
        else if (line.match(/^\d+\./)) {
            if (!currentSubject) {
                alert('请先指定科目！');
                return;
            }
                    
                   // 科目映射 - 将美术、地理、体育、音乐、生物映射到"other"
            const subjectMap = {
                '语文': 'chinese',
                '数学': 'math',
                '英语': 'english',
                '运动': 'sports',
                '历史': 'history',
                '道法': 'daofa',
                '美术': 'other',
                '地理': 'other',
                '体育': 'other',
                '音乐': 'other',
                '生物': 'other'
            };
            
            const subject = subjectMap[currentSubject] || 'other';
                    
                    // 提取任务内容
            const taskContent = line.substring(line.indexOf('.') + 1).trim();
                    
                   // 根据任务内容识别计划名称和图标
            let planName = '练习';
            let icon = 'fas fa-book';

// 特殊处理：运动科目 - 检查是否包含特定运动项目
            if (subject === 'sports') {
                let foundSport = false;
                // 检查任务内容中是否包含运动项目
                for (const sport of sportsItems) {
                    if (taskContent.includes(sport)) {
                        planName = sport;
                        icon = 'fas fa-running';
                        foundSport = true;
                        break;
                    }
                }
                // 如果没有找到特定运动项目，使用默认的运动图标
                if (!foundSport) {
                    planName = '运动';
                    icon = 'fas fa-running';
                }
            }
        // 优化改错类任务识别逻辑
                    if ((taskContent.includes('订') && taskContent.includes('卷')) || 
                        (taskContent.includes('订') && taskContent.includes('练习')) ||
                        taskContent.includes('错题')) {
                        planName = '改错';
                        icon = 'fas fa-calculator';
                    }
                    // 预复习类任务：包含"笔记"或"预习"
                    else if (taskContent.includes('笔记') || taskContent.includes('预习')) {
                        planName = '预复习';
                        icon = 'fas fa-book';
                    }
                    // 练习类任务
                    else if (taskContent.includes('练习') || taskContent.includes('习题') || 
                        taskContent.includes('课时') || taskContent.includes('卷') || 
                        taskContent.includes('题目')) {
                        planName = '练习';
                        icon = 'fas fa-book';
                    }
                    // 背默抄类任务
                    else if (taskContent.includes('默') || taskContent.includes('背') || 
                             taskContent.includes('复习') || taskContent.includes('摘抄') || 
                             taskContent.includes('抄写') || taskContent.includes('抄')) {
                        planName = '背默抄';
                        icon = 'fas fa-pencil-alt';
                    }
                    // 写作类任务
                    else if (taskContent.includes('作文') || taskContent.includes('周记') || 
                             taskContent.includes('短文')) {
                        planName = '写作';
                        icon = 'fas fa-pencil-alt';
                    }
                    // 听读类任务
                    else if (taskContent.includes('读')) {
                        planName = '听读';
                        icon = 'fas fa-headphones';
                    }
                    // 打卡类任务
                    else if (taskContent.includes('打卡')) {
                        planName = '打卡';
                        icon = 'fas fa-pencil-alt';
                    }
                    
                    // 特殊处理：如果科目是美术、地理、体育、音乐、生物，则计划名称为科目名称
                    if (['美术', '地理', '体育', '音乐', '生物'].includes(currentSubject)) {
                        planName = currentSubject;
                    }
                    
                    const newPlan = {
                        id: plans.length + newPlans.length > 0 ? Math.max(...plans.map(p => p.id), ...newPlans.map(p => p.id)) + 1 : 1,
                        subject: subject,
                        name: planName,
                        description: taskContent,
                        plannedDuration: plannedDuration,
                        repeat: batchRepeat,
                        completed: false,
                        running: false,
                        startTime: null,
                        totalDuration: 0,
                        createdAt: selectedDate.toISOString(),
                        icon: icon
                    };
                    
                    newPlans.push(newPlan);
                }
            }
            
            // 将新计划添加到现有计划中
            plans = plans.concat(newPlans);
            
            // 保存到本地存储
            localStorage.setItem('studyPlans', JSON.stringify(plans));
            
            // 重置表单并关闭模态框
            document.getElementById('batch-add-form').reset();
            batchAddModal.style.display = 'none';
            
            // 重新渲染
            renderPlans();
            updateStats();
        }

        // 保存编辑后的计划
        function saveEditedPlan() {
            const planIndex = plans.findIndex(p => p.id == currentEditPlanId);
            
            if (planIndex === -1) return;
            
            const planSubject = document.getElementById('edit-plan-subject').value;
            const planName = document.getElementById('edit-plan-name').value;
            const planDescription = document.getElementById('edit-plan-description').value;
            const plannedDuration = document.getElementById('edit-planned-duration').value;
            const planRepeat = document.getElementById('edit-plan-repeat').value;
            
            plans[planIndex].subject = planSubject;
            plans[planIndex].name = planName;
            plans[planIndex].description = planDescription;
            plans[planIndex].plannedDuration = plannedDuration;
            plans[planIndex].repeat = planRepeat;
            
            // 保存到本地存储
            localStorage.setItem('studyPlans', JSON.stringify(plans));
            
            // 关闭编辑模态框
            editPlanModal.style.display = 'none';
            
            // 重新渲染
            renderPlans();
            
            // 如果详情页面正在显示，更新详情页面
            if (currentDetailPlanId === currentEditPlanId) {
                openDetailModal(currentDetailPlanId);
                detailModal.style.display = 'block';
            }
            
            currentEditPlanId = null;
        }

 // 全局变量，跟踪当前正在运行的计时器
        let currentRunningTimer = null;

           // 计时功能
   function toggleTimer(planId) {
    const planIndex = plans.findIndex(p => p.id == planId);
    if (planIndex === -1) return;
    
    const plan = plans[planIndex];
    
    // 如果已经有计时器在运行，且不是当前计划
            if (currentRunningTimer && currentRunningTimer !== planId) {
                // 不允许同时运行多个计时器
                alert('请先完成当前正在进行的计划，再开始新的计划');
                return;
            }
    
    if (plan.running) {
         // 如果正在运行，暂停计时
                plan.running = false;
                currentRunningTimer = null;
            
            // 更新总持续时间
            if (plan.startTime) {
                plan.totalDuration = Date.now() - plan.startTime + (plan.totalDuration || 0);
                plan.startTime = null;
            }
            
            // 暂停计时器
            if (timers[planId]) {
                clearInterval(timers[planId]);
                delete timers[planId];
            }
        } else {
            // 开始计时
            plan.running = true;
currentRunningTimer = planId; 
            
            // 设置开始时间
            plan.startTime = Date.now();
            
            // 记录实际开始时间（只在第一次开始时记录）
            if (!plan.actualStartTime) {
                plan.actualStartTime = formatTime(new Date());
            }
            
            // 创建计时器
            startTimerInterval(planId);
        }
        
        // 保存到本地存储
        localStorage.setItem('studyPlans', JSON.stringify(plans));
        
        // 重新渲染
        renderPlans();
        updateStats();
        
        // 更新详情页面显示
        if (currentDetailPlanId == planId) {
            updateDetailTimerDisplay(plan);
        }
    }

           // 停止计时
    function stopTimer(planId) {
        const planIndex = plans.findIndex(p => p.id == planId);
        if (planIndex === -1) return;
        
        const plan = plans[planIndex];
        
        // 停止计时器
        if (timers[planId]) {
            clearInterval(timers[planId]);
            delete timers[planId];
        }
        
        // 更新总持续时间
        if (plan.running && plan.startTime) {
            plan.totalDuration = Date.now() - plan.startTime + (plan.totalDuration || 0);
            plan.startTime = null;
        }
        
        // 标记为完成
        plan.running = false;
        plan.completed = true;
 currentRunningTimer = null;
        
        // 记录实际结束时间
        if (plan.actualStartTime && !plan.actualEndTime) {
            plan.actualEndTime = formatTime(new Date());
        }
        
        // 保存到本地存储
        localStorage.setItem('studyPlans', JSON.stringify(plans));
        
        // 重新渲染
        renderPlans();
        updateStats();
        
        // 更新详情页面显示
        if (currentDetailPlanId == planId) {
            updateDetailTimerDisplay(plan);
            document.getElementById('detail-actual-time').textContent = 
                `${plan.actualStartTime} - ${plan.actualEndTime}`;
        }
    }

        // 备份数据
        function backupData() {
            const backupTime = new Date();
            document.getElementById('backup-time').textContent = backupTime.toLocaleString();
            backupModal.style.display = 'flex';
        }

        // 下载备份
        function downloadBackup() {
            const backupData = {
                plans: plans,
                checkins: checkins,
                backupTime: new Date().toISOString()
            };
            
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backupData, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "学习计划备份_" + new Date().toISOString().split('T')[0] + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            
            backupModal.style.display = 'none';
        }

        // 导入数据
        function importData() {
            const importDataText = document.getElementById('data-import').value;
            
            if (!importDataText.trim()) {
                alert('请输入备份数据！');
                return;
            }
            
            try {
                const importedData = JSON.parse(importDataText);
                
                if (importedData.plans && Array.isArray(importedData.plans)) {
                    plans = importedData.plans;
                    localStorage.setItem('studyPlans', JSON.stringify(plans));
                    
                    if (importedData.checkins && Array.isArray(importedData.checkins)) {
                        checkins = importedData.checkins;
                        localStorage.setItem('studyCheckins', JSON.stringify(checkins));
                    }
                    
                    // 重新渲染
                    renderPlans();
                    renderCalendar();
                    updateStats();
                    
                    importModal.style.display = 'none';
                    alert('数据导入成功！');
                } else {
                    alert('备份数据格式不正确！');
                }
            } catch (e) {
                alert('备份数据格式不正确！');
            }
        }

        // 清空所有计划
        function clearAllPlans() {
            plans = [];
            checkins = [];
            localStorage.setItem('studyPlans', JSON.stringify(plans));
            localStorage.setItem('studyCheckins', JSON.stringify(checkins));
            
            // 清除所有计时器
            for (const timerId in timers) {
                clearInterval(timers[timerId]);
            }
            timers = {};
            
            // 重新渲染
            renderPlans();
            renderCalendar();
            updateStats();
        }

        // 渲染日历
        function renderCalendar() {
            calendarGrid.innerHTML = '';
            
            const today = new Date();
            const startOfWeek = getStartOfWeek(today);
            startOfWeek.setDate(startOfWeek.getDate() + (currentWeekOffset * 7));
            
            for (let i = 0; i < 7; i++) {
                const day = new Date(startOfWeek);
                day.setDate(startOfWeek.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                // 检查是否是今天 - 重置时间为午夜进行比较
                const todayMidnight = new Date();
                todayMidnight.setHours(0, 0, 0, 0);
                const dayMidnight = new Date(day);
                dayMidnight.setHours(0, 0, 0, 0);
                
                // 检查是否是选中的日期 - 重置时间为午夜进行比较
                const selectedDateMidnight = new Date(selectedDate);
                selectedDateMidnight.setHours(0, 0, 0, 0);
                
                // 修复日期高亮逻辑
                if (dayMidnight.getTime() === todayMidnight.getTime() && dayMidnight.getTime() === selectedDateMidnight.getTime()) {
                    // 如果今天被选中，显示为橙色
                    dayElement.classList.add('today');
                } else if (dayMidnight.getTime() === todayMidnight.getTime()) {
                    // 如果是今天但未被选中，显示为橙色
                    dayElement.classList.add('today');
                } else if (dayMidnight.getTime() === selectedDateMidnight.getTime()) {
                    // 如果是选中的日期但不是今天，显示为蓝色
                    dayElement.classList.add('selected');
                }
                
                const dateStr = day.toISOString().split('T')[0];
                const checkin = checkins.find(c => c.date === dateStr);
                if (checkin && checkin.plans.length > 0) {
                    dayElement.classList.add('checked');
                }
                
                const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
                const month = day.getMonth() + 1;
                const date = day.getDate();
                const weekday = weekdays[day.getDay()];
                
                dayElement.innerHTML = `
                    <div class="weekday">周${weekday}</div>
                    <div class="date">${month}/${date}</div>
                `;
                
                // 添加点击事件
                dayElement.addEventListener('click', function() {
                    selectedDate = new Date(day);
                    renderCalendar();
                    renderPlans();
                    updateStats();
                });
                
                calendarGrid.appendChild(dayElement);
            }
        }

        // 渲染全年日历
        function renderFullCalendar(date) {
            calendarGridYear.innerHTML = '';
            
            const year = date.getFullYear();
            const month = date.getMonth();
            
            // 更新标题
            calendarMonthYear.textContent = `${year}年${month + 1}月`;
            
            // 添加星期头部
            const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
            for (let i = 0; i < 7; i++) {
                const weekdayElement = document.createElement('div');
                weekdayElement.className = 'calendar-weekday';
                weekdayElement.textContent = weekdays[i];
                calendarGridYear.appendChild(weekdayElement);
            }
            
            // 获取当月第一天是星期几
            const firstDay = new Date(year, month, 1);
            const firstDayWeekday = firstDay.getDay();
            
            // 获取当月天数
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // 填充空白
            for (let i = 0; i < firstDayWeekday; i++) {
                const emptyElement = document.createElement('div');
                emptyElement.className = 'calendar-day-year other-month';
                calendarGridYear.appendChild(emptyElement);
            }
            
            // 填充日期
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day-year';
                dayElement.textContent = day;
                
                // 检查是否是今天 - 重置时间为午夜进行比较
                const todayMidnight = new Date();
                todayMidnight.setHours(0, 0, 0, 0);
                const currentDate = new Date(year, month, day);
                currentDate.setHours(0, 0, 0, 0);
                
                if (currentDate.getTime() === todayMidnight.getTime()) {
                    dayElement.classList.add('today');
                }
                
                // 检查是否是选中的日期 - 重置时间为午夜进行比较
                if (selectedCalendarDate) {
                    const selectedCalendarDateMidnight = new Date(selectedCalendarDate);
                    selectedCalendarDateMidnight.setHours(0, 0, 0, 0);
                    
                    if (currentDate.getTime() === selectedCalendarDateMidnight.getTime()) {
                        dayElement.classList.add('selected');
                    }
                }
                
                // 添加点击事件
                dayElement.addEventListener('click', function() {
                    selectedCalendarDate = new Date(year, month, day);
                    renderFullCalendar(date);
                });
                
                calendarGridYear.appendChild(dayElement);
            }
        }

        // 获取一周的开始日期（周一）
        function getStartOfWeek(date) {
            const day = date.getDay();
            const diff = date.getDate() - day + (day === 0 ? -6 : 1);
            const startOfWeek = new Date(date);
            startOfWeek.setDate(diff);
            startOfWeek.setHours(0, 0, 0, 0);
            return startOfWeek;
        }

        // 更新周标题
        function updateWeekTitle() {
            const today = new Date();
            const startOfWeek = getStartOfWeek(today);
            startOfWeek.setDate(startOfWeek.getDate() + (currentWeekOffset * 7));
            
            const year = startOfWeek.getFullYear();
            const month = startOfWeek.getMonth() + 1;
            
            const firstDayOfYear = new Date(year, 0, 1);
            const days = Math.floor((startOfWeek - firstDayOfYear) / (24 * 60 * 60 * 1000));
            const weekNumber = Math.ceil((days + firstDayOfYear.getDay() + 1) / 7);
            
            weekTitle.textContent = `${year}年${month}月第${weekNumber}周`;
        }

                // 更新统计信息
        function updateStats() {
            // 获取选中日期的字符串
            const selectedDateMidnight = new Date(selectedDate);
            selectedDateMidnight.setHours(0, 0, 0, 0);
            const selectedDateStr = selectedDateMidnight.toISOString().split('T')[0];
            
            // 获取今天的日期字符串（用于连续打卡天数计算）
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayStr = today.toISOString().split('T')[0];
            
            // 计算连续打卡天数（仍然基于今天）
            const sortedDates = checkins.map(c => c.date).sort();
            let currentStreak = 0;
            
            if (sortedDates.includes(todayStr)) {
                currentStreak = 1;
                let currentDate = new Date(today);
                
                for (let i = 1; i <= 30; i++) {
                    currentDate.setDate(currentDate.getDate() - 1);
                    const prevDate = currentDate.toISOString().split('T')[0];
                    
                    if (sortedDates.includes(prevDate)) {
                        currentStreak++;
                    } else {
                        break;
                    }
                }
            }
            
            document.getElementById('streak-days').textContent = currentStreak;
            
            // 计算累计完成计划数（所有时间）
            const completedPlans = plans.filter(p => p.completed).length;
            document.getElementById('total-plans').textContent = completedPlans;
            
            // 计算选中日期的学习时间和运动时间
            let selectedDateStudyTime = 0;
            let selectedDateSportsTime = 0;
            
            plans.forEach(plan => {
                // 检查计划是否是选中日期完成的
                const planDate = new Date(plan.createdAt);
                planDate.setHours(0, 0, 0, 0);
                const planDateStr = planDate.toISOString().split('T')[0];
                
                if (planDateStr === selectedDateStr && plan.completed && plan.totalDuration) {
                    const durationHours = plan.totalDuration / (1000 * 60 * 60); // 转换为小时
                    
                    if (plan.subject === 'sports') {
                        selectedDateSportsTime += durationHours;
                    } else {
                        selectedDateStudyTime += durationHours;
                    }
                }
            });
            
            document.getElementById('today-study-time').textContent = selectedDateStudyTime.toFixed(1) + 'h';
            document.getElementById('today-sports-time').textContent = selectedDateSportsTime.toFixed(1) + 'h';
            
            // 计算选中日期的任务完成情况
            const selectedDatePlans = plans.filter(p => {
                const planDate = new Date(p.createdAt);
                planDate.setHours(0, 0, 0, 0);
                const planDateStr = planDate.toISOString().split('T')[0];
                return planDateStr === selectedDateStr;
            });
            
            const completedSelectedDatePlans = selectedDatePlans.filter(p => p.completed).length;
            document.getElementById('today-tasks').textContent = `${completedSelectedDatePlans}/${selectedDatePlans.length}`;
            document.getElementById('today-completion').textContent = selectedDatePlans.length > 0 ? 
                Math.round((completedSelectedDatePlans / selectedDatePlans.length) * 100) + '%' : '0%';
        }

        // 辅助函数
        function getRepeatText(repeat) {
            const repeatMap = {
                'once': '仅当天',
                'daily': '每天',
                'weekdays': '周一至周五',
                'weekly': '每周的这天'
            };
            return repeatMap[repeat] || '仅当天';
        }

        function getSubjectText(subject) {
            const subjectMap = {
                'english': '英语',
                'chinese': '语文',
                'math': '数学',
                'sports': '运动',
                'history': '历史',
                'daofa': '道法',
                'other': '其他'
            };
            return subjectMap[subject] || '其他';
        }

        function formatDate(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatTime(date) {
            return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
        }

        function formatDuration(ms) {
            const seconds = Math.floor(ms / 1000);
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
    </script>
</body>
</html>